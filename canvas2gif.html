<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>canvas2gif</title>
  <meta name="author" content="forresto">
  <meta name="description" content="canvas image data to animated gif" />
  
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  
  <script type="text/javascript" src="LZWEncoder.js"></script>
  <script type="text/javascript" src="NeuQuant.js"></script>
  <script type="text/javascript" src="GIFEncoder.js"></script>
  
  <script src="http://meemoo.org/meemoo/meemoo.js"></script>
  
  <style type="text/css">
    html, body {
      margin:0;
      padding:0;
    }
    .savedimg {
      cursor:pointer;
    }
  </style>
</head>
<body>
  
  <img id="gif" title="If you save this image, it won't be 100% valid. Click finalize first." />
  
  <div>
    <button id="finalize" onclick="finalize()">finalize gif</button> <span id="status"></span>
  </div>

  <div id="saved">
  </div>
    
  <script type="text/javascript">
  
    var encoder = new GIFEncoder();
    var building = false;
    var frames = 0;
    var quality = 0;
    
    var queue = [];
    
    $("#gif")
      .hide()
      .load(function(){
        $("#gif").show();
      });
    
    $("#finalize")
      .attr('disabled','disabled')
      .click(finalize);
    
    var finalize = function() {
      if (frames < 1) { 
        return false; 
      }
      
      encoder.finish();
      var dataurl = "data:image/gif;base64,"+window.btoa(encoder.stream().getData());
      $("#status").text("done");
      
      var savedImg = $('<img />')
        .attr({
          "src": dataurl,
          "title": frames+"-frame animation, click to send",
          "class": "savedimg"
        })
        .click(function(){
          Meemoo.send("gif", this.src);
        });
      $("#saved").prepend(savedImg);
      $("#gif").hide();
      
      $("#finalize").attr('disabled','disabled');
      
      Meemoo.send("gif", dataurl);
      
      building = false;
      frames = 0;
    }
    
    var encodeTimeout;
    
    function encodeQueue() {
      encoder.addFrame(queue.shift(), true);
      frames++;
      $("#status").text(frames + " frames encoded, " + queue.length + " queued");
      
      if (queue.length > 0) {
        // Encode the next frame
        encodeTimeout = setTimeout(encodeQueue, 500);
      } else {
        // Show the partially encoded GIF
        var dataurl = "data:image/gif;base64,"+window.btoa(encoder.stream().getData());
        $("#gif").attr("src", dataurl);
        $("#finalize").removeAttr('disabled');
      }
    }
    
    Meemoo.addInputs({
      image: {
        action: function (imageData) {
          if (!building) {
            building = true;
            encoder.start();
            encoder.setSize(imageData.width, imageData.height);
            if (quality===0) {
              encoder.setQuality( 6 );
            }
            // Loop
            encoder.setRepeat(0);
          }
          queue.push(imageData.data);
          $("#finalize").attr('disabled','disabled');
          $("#status").text(frames + " frames encoded, " + queue.length + " queued");
          
          // Aurora fix?
          $("#gif").attr("src", ""); 
          
          // Start encoding in .5 seconds, unless we get a new frame
          clearTimeout(encodeTimeout);
          encodeTimeout = setTimeout(encodeQueue, 500);
        },
        port: true,
        type: "image"
      },
      quality: {
        action: function (i) {
          // from 1 (best) to 20 (fastest)
          quality = 20-Math.floor(i/100*19);
          encoder.setQuality( quality );
        },
        port: true,
        type: "int",
        min: "0",
        max: "100"
      },
      delay: {
        action: function (i) {
          encoder.setDelay(i);
        },
        port: true,
        type: "int"
      },
      finalize: {
        action: finalize,
        port: true,
        type: "bang"
      }
      
    }).addOutputs({
      gif: {
        port: true,
        type: "data:image/gif"
      }
    });
    
  </script>
  
</body>
</html>