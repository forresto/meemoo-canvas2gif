<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>canvas2gif</title>
  <meta name="author" content="forresto">
  <meta name="description" content="canvas image data to animated gif" />
  
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  
  <script type="text/javascript" src="LZWEncoder.js"></script>
  <script type="text/javascript" src="NeuQuant.js"></script>
  <script type="text/javascript" src="GIFEncoder.js"></script>
  
  <script src="http://meemoo.org/meemoo/meemoo.js"></script>
  
  <style type="text/css">
    html, body {
      margin:0;
      padding:0;
    }
    .savedimg {
      cursor:pointer;
    }
  </style>
</head>
<body>
  
  <img id="gif" title="If you save this image, it won't be 100% valid. Click finalize first." />
  
  <div>
    <button id="finalize" onclick="finalize()">finalize gif</button> <span id="status"></span>
  </div>

  <div id="saved">
  </div>

  <div id="matte" style="display:none;">
  </div>
    
  <script type="text/javascript">
  
    var encoder = new GIFEncoder();
    var building = false;
    var frames = 0;
    var quality = 0;
    
    var queue = [];
    
    $("#gif")
      .hide()
      .load(function(){
        $("#gif").show();
      });
    
    $("#finalize")
      .attr('disabled','disabled')
      .click(finalize);
    
    var finalize = function() {
      if (frames < 1) { 
        return false; 
      }
      
      encoder.finish();
      var dataurl = "data:image/gif;base64,"+window.btoa(encoder.stream().getData());
      $("#status").text("done");
      
      var savedImg = $('<img />')
        .attr({
          "src": dataurl,
          "title": frames+"-frame animation, click to send",
          "class": "savedimg"
        })
        .click(function(){
          Meemoo.send("gif", this.src);
        });
      $("#saved").prepend(savedImg);
      $("#gif").hide();
      
      $("#finalize").attr('disabled','disabled');
      
      Meemoo.send("gif", dataurl);
      
      building = false;
      frames = 0;
    }
    
    var encodeTimeout;
    
    function encodeQueue() {
      imageData = queue.shift();
      if (matteCanvasContext) {
        // Fill matte
        matteCanvasContext.fillStyle = transparentColor;
        matteCanvasContext.fillRect(0, 0, matteCanvas.width, matteCanvas.height);
        // Draw new frame
        addCanvasContext.putImageData(imageData, 0, 0);
        // Combine matte and new frame
        matteCanvasContext.drawImage(addCanvas, 0, 0);
        imageData = matteCanvasContext.getImageData(0, 0, matteCanvas.width, matteCanvas.height);
      }
      encoder.addFrame(imageData.data, true);
      frames++;
      $("#status").text(frames + " frames encoded, " + queue.length + " queued");
      
      if (queue.length > 0) {
        // Encode the next frame
        encodeTimeout = setTimeout(encodeQueue, 500);
      } else {
        // Show the partially encoded GIF
        var dataurl = "data:image/gif;base64,"+window.btoa(encoder.stream().getData());
        $("#gif").attr("src", dataurl);
        $("#finalize").removeAttr('disabled');
      }
    }
    
    function addImage (imageData) {
      if (!building) {
        building = true;
        encoder.start();
        encoder.setSize(imageData.width, imageData.height);
        if (quality===0) {
          encoder.setQuality( 6 );
        }
        // Loop
        encoder.setRepeat(0);
        // Matte
        if (transparentColor) {
          encoder.setTransparent( parseInt("0x"+transparentColor.substring(1,transparentColor.length)) );
          
          matteCanvas = $("<canvas />");
          matteCanvas = $("<canvas />")[0];
          matteCanvas.width = imageData.width;
          matteCanvas.height = imageData.height;
          matteCanvasContext = matteCanvas.getContext('2d');
          $("#matte").append(matteCanvas);
          
          addCanvas = $("<canvas />");
          addCanvas = $("<canvas />")[0];
          addCanvas.width = imageData.width;
          addCanvas.height = imageData.height;
          addCanvasContext = addCanvas.getContext('2d');
          $("#matte").append(addCanvas);
          
        }
      }
      queue.push(imageData);
      $("#finalize").attr('disabled','disabled');
      $("#status").text(frames + " frames encoded, " + queue.length + " queued");
      
      // Aurora fix?
      $("#gif").attr("src", ""); 
      
      // Start encoding in .5 seconds, unless we get a new frame
      clearTimeout(encodeTimeout);
      encodeTimeout = setTimeout(encodeQueue, 500);
    }
    
    var transparentColor;
    var matteCanvas;
    var matteCanvasContext;
    var addCanvas;
    var addCanvasContext;
    
    function setTransparent (color) {
      if (color === undefined) {
        transparentColor = undefined;
        matteCanvas = undefined;
        matteCanvasContext = undefined;
      } else {
        transparentColor = color;
      }
    }
    
    Meemoo.addInputs({
      image: {
        action: addImage,
        type: "image"
      },
      quality: {
        action: function (i) {
          // from 1 (best) to 20 (fastest)
          quality = 20-Math.floor(i/100*19);
          encoder.setQuality( quality );
        },
        type: "int",
        min: "0",
        max: "100",
        description: "from 0 (fastest) to 100 (best)"
      },
      delay: {
        action: function (i) {
          encoder.setDelay(i);
        },
        type: "int"
      },
      transparent: {
        action: setTransparent,
        type: "color"
      },
      finalize: {
        action: finalize,
        type: "bang"
      }
      
    }).addOutputs({
      gif: {
        type: "data:image/gif"
      }
    });
    
  </script>
  
</body>
</html>